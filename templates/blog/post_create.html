{% extends 'base.html' %}
<br />
{% block title %}{% if "/create/" in request.path %} 새 글 작성 {% else %}
(작성중) {{ post.title }} {% endif %} {% endblock %} {% block content %} {% load markdown_deux_tags %}
<link
rel="stylesheet"
href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"
/>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

{% if "/create/" in request.path %}
<h1 class="">글쓰기{% else %}글 수정{% endif %}</h1>
<div class="pl-4 pr-4">
<form action="" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  
  <div class="form-group">
    <label for="title"></label>
    <input
    type="text"
    class="form-control text-6xl bg-gray-300 font-bold"
    id="title"
    name="title"
    value="{% if post.title %}{{ post.title }}{% endif %}"
    placeholder="제목을 입력하세요"
    />
  </div>
  
      
      <div class="bg-slate-100 rounded mt-10" id="contents">
        {% if post.content %}{{ post.content|markdown }}{% else %}{% endif %}
      </div>
    <div class="form-group">
      
      <textarea class="content form-control hidden" id="content" name="content" rows="10">
</textarea
      >
    </div>

    <div class="form-group">
      <label for="thumbnail">Thumbnail</label>
      <input
        type="file"
        class="form-control-file"
        id="thumbnail"
        name="thumbnail"
        accept="image/*"
        value="{% if post.thumbnail %}{{ post.thumbnail.url }}{% endif %}"
      />
    </div>

    <div class="form-group">
      <label for="file_upload">File upload</label>
      <input
        type="file"
        class="form-control-file"
        id="file_upload"
        name="file_upload"
        value="{% if post.file_upload %}{{ post.file_upload.url }}{% endif %}"
      />
    </div>

    <input type="submit" value={% if "/create/" in request.path %}"Create post"
    {%else %} "Edit post" {% endif %} class="btn btn-primary bg-blue-300
    rounded" />
  </form>
</div>

  {% endblock %} {% block scripts %}

  <script>
    const csrftoken = document.querySelector('[name="csrfmiddlewaretoken"]').value;
    const editor = new toastui.Editor({
      el: document.querySelector('#contents'),  // 마크다운 프리뷰 스타일 (tab || vertical) 
      height: '600px',
      initialEditType: 'markdown',
      previewStyle: 'vertical',
      hooks : {
        addImageBlobHook: (blob, callback) => uploadImages(blob, callback)
      },
    });

    const uploadImages = (blob, callback) => {
      let xhr = new XMLHttpRequest();
      
      //이미지, csrf토큰을 가지고 /blog/upload로 POST요청
      xhr.open('POST', '/blog/upload', true);
      xhr.setRequestHeader('X-CSRFToken', csrftoken);
      
      const formData = new FormData();
      formData.append('images', blob);
    
      xhr.send(formData);
      
      // 받은 imageURL을 이미지의 src로 사용
      xhr.onload = function() {
        if (xhr.status === 200) {
          const imageUrl = JSON.parse(xhr.responseText).url;
          callback(imageUrl);
        } else {
          callback(alert('이미지 업로드에 실패하였습니다. 다음에 다시 시도해주세요.'));
        }
      };
    };


    const submit = document.querySelector("input[type='submit']")
    const content = document.querySelector('.content')
    submit.addEventListener('click', () => {
      editorcontent = editor.getMarkdown();
      content.value = editorcontent;
    })

    
    
    
  </script>
  {% endblock scripts %}
</div>
